<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Conexi√≥n - Comercial Liliana</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #2C4A6B;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #ddd;
    }

    .test-item.testing {
      border-left-color: #FFA500;
    }

    .test-item.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .test-item.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .test-name {
      font-weight: 600;
      color: #2C4A6B;
      margin-bottom: 5px;
      font-size: 16px;
    }

    .test-status {
      font-size: 14px;
      color: #666;
    }

    .test-detail {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
      font-family: monospace;
    }

    .icon {
      display: inline-block;
      margin-right: 8px;
      font-size: 18px;
    }

    .btn {
      background: #6B9DC2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #2C4A6B;
      transform: translateY(-2px);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .summary {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
      text-align: center;
    }

    .summary h2 {
      color: #2C4A6B;
      margin-bottom: 10px;
    }

    .summary-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }

    .success-color { color: #28a745; }
    .error-color { color: #dc3545; }
    .warning-color { color: #FFA500; }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #28a745;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      color: #721c24;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <div class="container">
    <h1>üîß Test de Conexi√≥n</h1>
    <p class="subtitle">Comercial Liliana - Verificaci√≥n de Configuraci√≥n</p>

    <div id="tests">
      <div class="test-item" id="test-config">
        <div class="test-name"><span class="icon">üìã</span> Archivo de Configuraci√≥n</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-supabase-url">
        <div class="test-name"><span class="icon">üîó</span> URL de Supabase</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-supabase-key">
        <div class="test-name"><span class="icon">üîë</span> API Key de Supabase</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-supabase-connection">
        <div class="test-name"><span class="icon">üóÑÔ∏è</span> Conexi√≥n a Supabase</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-categories">
        <div class="test-name"><span class="icon">üì¶</span> Tabla de Categor√≠as</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-r2-public">
        <div class="test-name"><span class="icon">‚òÅÔ∏è</span> URL P√∫blica de R2</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-r2-worker">
        <div class="test-name"><span class="icon">‚ö°</span> Worker de Cloudflare</div>
        <div class="test-status">Esperando...</div>
      </div>

      <div class="test-item" id="test-whatsapp">
        <div class="test-name"><span class="icon">üí¨</span> N√∫mero de WhatsApp</div>
        <div class="test-status">Esperando...</div>
      </div>
    </div>

    <button class="btn" id="runTests" onclick="runAllTests()">
      Ejecutar Tests
    </button>

    <div id="summary" style="display: none;"></div>
    <div id="alert" style="display: none;"></div>
  </div>

  <script src="./js/config.js"></script>

  <script>
    let testResults = {
      total: 0,
      passed: 0,
      failed: 0
    };

    function updateTestStatus(testId, status, message, detail = '') {
      const element = document.getElementById(testId);
      element.className = `test-item ${status}`;
      element.querySelector('.test-status').textContent = message;

      if (detail) {
        let detailDiv = element.querySelector('.test-detail');
        if (!detailDiv) {
          detailDiv = document.createElement('div');
          detailDiv.className = 'test-detail';
          element.appendChild(detailDiv);
        }
        detailDiv.textContent = detail;
      }
    }

    async function runAllTests() {
      document.getElementById('runTests').disabled = true;
      document.getElementById('summary').style.display = 'none';
      document.getElementById('alert').style.display = 'none';
      testResults = { total: 8, passed: 0, failed: 0 };

      // Test 1: Configuraci√≥n cargada
      updateTestStatus('test-config', 'testing', 'Verificando...');
      await sleep(500);
      if (typeof CONFIG !== 'undefined') {
        updateTestStatus('test-config', 'success', '‚úÖ Configuraci√≥n cargada correctamente');
        testResults.passed++;
      } else {
        updateTestStatus('test-config', 'error', '‚ùå No se pudo cargar config.js');
        testResults.failed++;
        showFinalSummary();
        return;
      }

      // Test 2: URL de Supabase
      updateTestStatus('test-supabase-url', 'testing', 'Verificando...');
      await sleep(500);
      if (CONFIG.SUPABASE_URL && CONFIG.SUPABASE_URL.includes('supabase.co')) {
        updateTestStatus('test-supabase-url', 'success', '‚úÖ URL de Supabase v√°lida', CONFIG.SUPABASE_URL);
        testResults.passed++;
      } else {
        updateTestStatus('test-supabase-url', 'error', '‚ùå URL de Supabase inv√°lida o no configurada', CONFIG.SUPABASE_URL);
        testResults.failed++;
      }

      // Test 3: API Key
      updateTestStatus('test-supabase-key', 'testing', 'Verificando...');
      await sleep(500);
      if (CONFIG.SUPABASE_ANON_KEY && CONFIG.SUPABASE_ANON_KEY.length > 100 && CONFIG.SUPABASE_ANON_KEY.startsWith('eyJ')) {
        updateTestStatus('test-supabase-key', 'success', '‚úÖ API Key v√°lida', `${CONFIG.SUPABASE_ANON_KEY.substring(0, 30)}...`);
        testResults.passed++;
      } else {
        updateTestStatus('test-supabase-key', 'error', '‚ùå API Key inv√°lida o no configurada');
        testResults.failed++;
      }

      // Test 4: Conexi√≥n a Supabase
      updateTestStatus('test-supabase-connection', 'testing', 'Conectando...');
      try {
        const client = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const { data, error } = await client.from('categorias').select('count').limit(1);

        if (!error) {
          updateTestStatus('test-supabase-connection', 'success', '‚úÖ Conexi√≥n exitosa a Supabase');
          testResults.passed++;
        } else {
          updateTestStatus('test-supabase-connection', 'error', '‚ùå Error de conexi√≥n', error.message);
          testResults.failed++;
        }
      } catch (err) {
        updateTestStatus('test-supabase-connection', 'error', '‚ùå Error al conectar', err.message);
        testResults.failed++;
      }

      // Test 5: Tabla de categor√≠as
      updateTestStatus('test-categories', 'testing', 'Verificando...');
      try {
        const client = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const { data, error } = await client.from('categorias').select('*');

        if (!error && data && data.length > 0) {
          updateTestStatus('test-categories', 'success', `‚úÖ ${data.length} categor√≠as encontradas`);
          testResults.passed++;
        } else {
          updateTestStatus('test-categories', 'error', '‚ùå No se encontraron categor√≠as', 'Ejecuta el SQL de supabase-schema.sql');
          testResults.failed++;
        }
      } catch (err) {
        updateTestStatus('test-categories', 'error', '‚ùå Error al consultar categor√≠as', err.message);
        testResults.failed++;
      }

      // Test 6: R2 Public URL
      updateTestStatus('test-r2-public', 'testing', 'Verificando...');
      await sleep(500);
      if (CONFIG.R2_PUBLIC_URL && CONFIG.R2_PUBLIC_URL.includes('r2.dev')) {
        updateTestStatus('test-r2-public', 'success', '‚úÖ URL p√∫blica de R2 v√°lida', CONFIG.R2_PUBLIC_URL);
        testResults.passed++;
      } else {
        updateTestStatus('test-r2-public', 'error', '‚ùå URL de R2 inv√°lida o no configurada', CONFIG.R2_PUBLIC_URL);
        testResults.failed++;
      }

      // Test 7: Worker URL
      updateTestStatus('test-r2-worker', 'testing', 'Verificando...');
      await sleep(500);
      if (CONFIG.R2_WORKER_URL && CONFIG.R2_WORKER_URL.includes('workers.dev')) {
        updateTestStatus('test-r2-worker', 'success', '‚úÖ URL del Worker v√°lida', CONFIG.R2_WORKER_URL);
        testResults.passed++;
      } else {
        updateTestStatus('test-r2-worker', 'error', '‚ùå URL del Worker inv√°lida o no configurada', CONFIG.R2_WORKER_URL);
        testResults.failed++;
      }

      // Test 8: WhatsApp
      updateTestStatus('test-whatsapp', 'testing', 'Verificando...');
      await sleep(500);
      if (CONFIG.WHATSAPP_NUMBER && CONFIG.WHATSAPP_NUMBER.length >= 10) {
        updateTestStatus('test-whatsapp', 'success', '‚úÖ N√∫mero de WhatsApp configurado', `+${CONFIG.WHATSAPP_NUMBER}`);
        testResults.passed++;
      } else {
        updateTestStatus('test-whatsapp', 'error', '‚ùå N√∫mero de WhatsApp no configurado');
        testResults.failed++;
      }

      showFinalSummary();
    }

    function showFinalSummary() {
      const summaryDiv = document.getElementById('summary');
      const alertDiv = document.getElementById('alert');

      const percentage = Math.round((testResults.passed / testResults.total) * 100);

      summaryDiv.innerHTML = `
        <h2>Resultados del Test</h2>
        <div class="summary-stats">
          <div class="stat">
            <div class="stat-number success-color">${testResults.passed}</div>
            <div class="stat-label">Pasaron</div>
          </div>
          <div class="stat">
            <div class="stat-number error-color">${testResults.failed}</div>
            <div class="stat-label">Fallaron</div>
          </div>
          <div class="stat">
            <div class="stat-number">${percentage}%</div>
            <div class="stat-label">Completado</div>
          </div>
        </div>
      `;
      summaryDiv.style.display = 'block';

      if (testResults.failed === 0) {
        alertDiv.className = 'alert alert-success';
        alertDiv.innerHTML = `
          <strong>üéâ ¬°Excelente!</strong><br>
          Todas las pruebas pasaron correctamente. Tu cat√°logo est√° listo para usar.<br><br>
          <strong>Pr√≥ximos pasos:</strong><br>
          1. Ve a <code>/admin/</code> para agregar productos<br>
          2. Sube im√°genes de tus productos<br>
          3. Comparte el enlace con tus clientes
        `;
      } else if (testResults.failed <= 2) {
        alertDiv.className = 'alert alert-warning';
        alertDiv.innerHTML = `
          <strong>‚ö†Ô∏è Atenci√≥n</strong><br>
          Algunas pruebas fallaron. Revisa los errores arriba y corr√≠gelos.<br>
          Consulta el archivo <strong>SOLUCIONES-PROBLEMAS.md</strong> para ayuda.
        `;
      } else {
        alertDiv.className = 'alert alert-error';
        alertDiv.innerHTML = `
          <strong>‚ùå Configuraci√≥n Incompleta</strong><br>
          Varias pruebas fallaron. Verifica que hayas completado todos los pasos de <strong>INICIO-RAPIDO.md</strong>.<br><br>
          <strong>Errores comunes:</strong><br>
          ‚Ä¢ No completaste el archivo config.js<br>
          ‚Ä¢ Las credenciales de Supabase son incorrectas<br>
          ‚Ä¢ No ejecutaste el SQL en Supabase<br>
          ‚Ä¢ No configuraste el Worker de Cloudflare
        `;
      }
      alertDiv.style.display = 'block';

      document.getElementById('runTests').disabled = false;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>

</body>
</html>
